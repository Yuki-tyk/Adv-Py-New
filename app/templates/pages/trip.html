{% extends 'base.html' %}

{% block title %}
One Trip
{% endblock title %}

{% block content %}
<style>
    .description-container {
        margin-left: 200px;
        padding-top: 10px;
    }
</style>

<div class="position-fixed bottom-0 start-0 p-3">
    <h4 class="mb-0"><a href="/AllTrip">Back</a></h3>
</div>

<div class="container">
    <div class="container text-center">
        <div class="row justify-content-center">
            <div class="col-4" style="text-align: left;">
                <h2>Trip - {{ trip_attributes['name'] }}</h2>
            </div>
            <div class="col-4" style="text-align: right;">
                <h5>ID: {{ trip_attributes['ID'] }}</h5>
            </div>
        </div>
        
        <div class="row justify-content-center">
            <div class="col-4" style="text-align: left;">
                <h4>City: <span class="location-box">{{ trip_attributes['location'] }}</h4>
            </div>
            <div class="col-4" style="text-align: right;">
                <h4>{{ trip_attributes['startDate'] }} to {{ trip_attributes['endDate'] }}</h4>
            </div>
        </div>
    </div>

    <div class="description-container">
        <h5> Description: </h5>
        <p>{{ trip_attributes['tripDescription'] }}</p>
    </div>

    <div class="row">
        <div class="col-sm-6">
            <br/>
            <iframe
                    width="500"
                    height="500"
                    style="border:0"
                    loading="lazy"
                    allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade"
                    src="https://www.google.com/maps/embed/v1/place?key=AIzaSyDpuP065vE8YOy1EVvwZdC2C3d0ugrLntY&q={{ trip_attributes['location'] }}">
            </iframe>
        </div>

        <div class="col-sm-6">
            <div class="d-flex justify-content-center">
                <table class="table my-5 custom-table table-light text-center">
                    <thead>
                        <tr>
                            <th colspan="5" class="text-center enlarged-header">The Weather of {{ trip_attributes['location'] }} in the Coming Five Days</th>
                        </tr>
                        <tr>
                            <th class='col-2.5'>Date</th>
                            <th class='col-2.5'>Temp (°C)</th>
                            <th class='col-2.5'>Feels like(°C)</th>
                            <th class='col-2.5'>Weather</th>
                            <th class='col-2.5'>Humidity(%)</th>
                        </tr>
                    </thead>
                    <tbody>
                            {% for key, value in weather.items() %}
                                {% set date_parts = key.split('-') %}
                                <tr>
                                    <td class='col-2.5'>{{ date_parts[2] }}/{{ date_parts[1] }}</td>
                                    <td class='col-2.5'>{{value["Temperature"]}}</td>
                                    <td class='col-2.5'>{{value["Feel Like"]}}</td>
                                    <td class='col-2.5'>{{value["Weather"]}}</td>
                                    <td class='col-2.5'>{{value["Humidity"]}}</td>
                                </tr>
                            {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <br/>
</div>

<div class="container">
    <div class="d-flex justify-content-center">
        <table class="table custom-table table-light" style="width: 50%;">
            <thead>
                <tr>
                    <th colspan="5" class="text-center enlarged-header">User Net</th>
                </tr>
                <tr>
                    <th class="text-center">User Name</th>
                    <th class="text-center">Net Amount</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users_net %}
                <tr>
                    <td class="text-center">{{ user[0] }}</td>
                    <td class="text-center">{{ user[1] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <br>
</div>

<div class="container">
  <div class="row">
      <div class="col-sm-4"></div>
      <div class="col-sm-4">
          <h3 style="text-align: center">List of activities</h3>
      </div>
      <div class="col-sm-2">
          <form method="GET" action="{{ url_for('editEvent_page') }}">
              <input type="hidden" name="tripID" value="{{ trip_attributes['ID'] }}">
              <button type="submit" class="btn btn-primary btn-lg btn-block">+ Event</button>
          </form>
      </div>

      <div class="col-sm-2">
          <form method="GET" action="{{ url_for('editTransaction_page') }}">
              <input type="hidden" name="tripID" value="{{ trip_attributes['ID'] }}">
              <button type="submit" class="btn btn-primary btn-lg btn-block">+ Transaction</button>
          </form>
      </div>
  </div>
  <hr>
</div>

  {% for k, value in activities.items() %}
    <div class="container">
      <div class="row"> 
        <div class="col-10">
            <h4 style="margin: 0;">
              {% if value['debtSettlement'] %} Debt Settlement
              {% else %}
                {{value['type']}} 
              {% endif %} - {{value['name']}} {% if value['category'] and value['category'] != "Uncategorized"%} <span class="small">({{value['category']}})</span> {% endif %}
          </h4>
          </div>

          <div class ="col">
            <button class="btn btn-outline-danger btn-lg btn-block" onclick="confirmDeleteActivity({{ value['ID'] }})">Delete</button>
          </div>
        </div>
        <div class="row">
          
          <div class="col-10">
              <!-- if is debtSettlement -->
              <p style="margin: 0;">
                {% if value['debtSettlement'] %}
                  <!-- show all paying user -->
                  {% for i in value['paid'] %}
                      <span class="user-id">{{ i }}</span><!-- delete the last comma -->{% if not loop.last %},{% endif %}
                  {% endfor %}
                  
                  <!-- show all user being paid -->
                  paid 
                  {% for i in value['received'] %}
                      <span class="user-id">{{ i }}</span><!-- delete the last comma -->{% if not loop.last %},{% endif %}
                  {% endfor %}
              
                  {% else %} 
                      <!-- User  -->
                      {% if value['type'] == 'Event' %} 
                          {% for i in value['linkedUser']%} 
                              <span class="user-id">{{ i }}</span>{% if not loop.last %},{% endif %} 
                          {% endfor %} 
                          
                  {% else %}
                          
                          {% for i in value['paid'] %} 
                              <span class="user-id">{{ i }}</span>{% if not loop.last%},{% endif %} 
                          {% endfor %} 
                          paid for 
                          {% for i in value['received']%} 
                              <span class="user-id">{{ i }}</span>{% if not loop.last %},{% endif %} 
                          {% endfor %} 
                          
                  {% endif %} 
                      
                {% endif %}
                </p>

                <p class="cool-date">
                  {{value['startTime']}} {% if value['endTime'] %} to {{value['endTime']}}
                  {% endif %}
                </p>

            </div>

          <div class ="col" style="display: flex; justify-content: center;">
            <br>
            {% if value['totalAmount'] %}
              <div style="margin-top: 10%;">
                <h4 style="margin: 0; display: flex; justify-content: center;">{{value['totalAmount']}} {{value['currency']}}</h4>
              </div>
            {% endif %}

          </div>
        </div>


        </div>
      </div>

      <hr class="container">
    {% endfor %}
    <br>
    <div class="container">
        <button class="btn btn-outline-danger btn-lg btn-block" onclick="confirmDeleteTrip({{ trip_attributes['ID'] }})">Delete</button>
    </div>
    <br>
</div>


<script>
    function confirmDeleteActivity(activityID) {
      var type = activityID[0]
      switch (type) {
        case "3":
          var use_url = '/delete/event/'
          break
        case "4":
          var use_url = '/delete/transaction/'
          break
      }
      var result = window.confirm("Are you sure you want to delete this Transaction?");
      if (result) {
        // User clicked "OK"
        $.ajax({
          url: use_url + activityID,
          type: 'DELETE',
          success: function(response) {
            // Handle the success response from the server
            console.log(response); // Log the response or update the UI accordingly
            location.reload();
          },
          error: function(xhr, status, error) {
            // Handle the error response from the server
            console.log(error); // Log the error or perform any other action as needed
          }
        });
      } else {
        // User clicked "Cancel" or closed the dialog
        // Do nothing or perform any other action as needed
      }
    }
  </script>


<script>
    function confirmDeleteTrip(tripID) {
      var result = window.confirm("Are you sure you want to delete this trip?");
      if (result) {
        // User clicked "OK"
        $.ajax({
          url: '/delete/trip/' + tripID,
          type: 'DELETE',
          success: function(response) {
            // Handle the success response from the server
            console.log(response); // Log the response or update the UI accordingly
            window.location.href = '/AllTrip';
          },
          error: function(xhr, status, error) {
            // Handle the error response from the server
            console.log(error); // Log the error or perform any other action as needed
          }
        });
      } else {
        // User clicked "Cancel" or closed the dialog
        // Do nothing or perform any other action as needed
      }
    }
  </script>
{% endblock %}
